<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чат с Привокзальным Сократом</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=PT+Mono&display=swap');
        :root {
            --background-color: #1a1a1a;
            --text-color: #e0e0e0;
            --accent-color: #ff9900;
            --user-msg-bg: #33334d;
            --assistant-msg-bg: #2a3a2a;
            --form-bg: #2c2c2c;
        }
        body { margin: 0; font-family: 'PT Mono', monospace; background-color: var(--background-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #chat-container { width: 100%; max-width: 800px; height: 95vh; display: none; flex-direction: column; border: 1px solid #444; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #chat-container.visible { display: flex; }
        /* НОВАЯ ШАПКА ЧАТА */
        #chat-header { padding: 10px 20px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        #logout-button { background: none; border: 1px solid #777; color: #aaa; cursor: pointer; border-radius: 4px; padding: 5px 10px; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; line-height: 1.4; }
        .user { background-color: var(--user-msg-bg); align-self: flex-end; border-bottom-right-radius: 3px; }
        .assistant { background-color: var(--assistant-msg-bg); align-self: flex-start; border-bottom-left-radius: 3px; }
        .typing-indicator { align-self: flex-start; color: #888; font-style: italic; }
        #input-area { display: flex; padding: 10px; border-top: 1px solid #444; }
        #message-input { flex-grow: 1; background-color: #333; border: 1px solid #555; border-radius: 20px; padding: 10px 15px; color: var(--text-color); font-family: 'PT Mono', monospace; }
        #message-input:focus { outline: none; border-color: var(--accent-color); }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
        #auth-overlay.hidden { display: none; }
        #auth-form { background-color: var(--form-bg); padding: 40px; border-radius: 8px; box-shadow: 0 0 30px rgba(255, 153, 0, 0.3); width: 300px; text-align: center; }
        #auth-form h2 { color: var(--accent-color); margin-top: 0; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; background-color: #333; border: 1px solid #555; border-radius: 4px; color: var(--text-color); box-sizing: border-box; }
        .auth-button { width: 100%; padding: 12px; border: none; border-radius: 4px; background-color: var(--accent-color); color: #111; font-weight: bold; cursor: pointer; margin-bottom: 10px; font-size: 16px; }
        .auth-button:hover { opacity: 0.9; }
        #toggle-link { cursor: pointer; color: #aaa; text-decoration: underline; font-size: 14px; }
        #error-message { color: #ff4d4d; min-height: 20px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div id="auth-form">
            <h2 id="form-title">Вход</h2>
            <div id="error-message"></div>
            <input type="text" id="username" class="auth-input" placeholder="Имя">
            <input type="password" id="password" class="auth-input" placeholder="Пароль">
            <button id="main-button" class="auth-button">Войти</button>
            <p id="toggle-link">Нет аккаунта? Зарегистрироваться</p>
        </div>
    </div>

    <div id="chat-container">
        <div id="chat-header">
            <span id="user-info"></span>
            <button id="logout-button">Выйти</button>
        </div>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="Спросить Сократа...">
        </div>
    </div>

<script>
    const authOverlay = document.getElementById('auth-overlay');
    const mainButton = document.getElementById('main-button');
    const toggleLink = document.getElementById('toggle-link');
    const errorMessage = document.getElementById('error-message');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const formTitle = document.getElementById('form-title');
    const chatContainer = document.getElementById('chat-container');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const userInfo = document.getElementById('user-info');
    const logoutButton = document.getElementById('logout-button');

    let isLoginMode = true;
    let socket = null;

    window.addEventListener('load', () => {
        const token = localStorage.getItem('accessToken');
        if (token) {
            initializeChat(token);
        } else {
            authOverlay.classList.remove('hidden');
        }
    });

    toggleLink.addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        errorMessage.textContent = '';
        formTitle.textContent = isLoginMode ? 'Вход' : 'Регистрация';
        mainButton.textContent = isLoginMode ? 'Войти' : 'Создать аккаунт';
        toggleLink.textContent = isLoginMode ? 'Нет аккаунта? Зарегистрироваться' : 'Уже есть аккаунт? Войти';
    });

    logoutButton.addEventListener('click', () => {
        localStorage.removeItem('accessToken');
        if(socket) socket.close();
        window.location.reload();
    });

    mainButton.addEventListener('click', async () => {
        const username = usernameInput.value;
        const password = passwordInput.value;
        if (!username || !password) {
            errorMessage.textContent = 'Имя и пароль не могут быть пустыми.';
            return;
        }

        try {
            if (isLoginMode) {
                const response = await fetch('http://api/token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `grant_type=&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&scope=&client_id=&client_secret=`
                });
                if (!response.ok) throw new Error('Неверное имя или пароль.');
                const data = await response.json();

                localStorage.setItem('accessToken', data.access_token);

                initializeChat(data.access_token);
            } else {
                const response = await fetch('http://api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Ошибка регистрации.');
                }
                errorMessage.textContent = 'Аккаунт создан! Теперь войдите.';
                toggleLink.click();
            }
        } catch (error) {
            errorMessage.textContent = error.message;
        }
    });

    async function initializeChat(token) {
        try {
            const user = await getUserProfile(token);
            userInfo.textContent = `Вы: ${user.username}`;

            authOverlay.classList.add('hidden');
            chatContainer.classList.add('visible');

            const wsUrl = `ws://${window.location.host}/ws?token=${token}`;
            socket = new WebSocket(wsUrl);
            setupSocketHandlers();

        } catch (error) {
            console.error("Ошибка инициализации чата:", error);
            localStorage.removeItem('accessToken');
            authOverlay.classList.remove('hidden');
            errorMessage.textContent = 'Сессия истекла. Пожалуйста, войдите снова.';
        }
    }

    async function getUserProfile(token) {
        const response = await fetch('http://api/users/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) {
            throw new Error('Не удалось получить профиль пользователя.');
        }
        return await response.json();
    }

    function setupSocketHandlers() {
        socket.onopen = () => addMessage('Сократ присоединился к чату.', 'assistant');
        socket.onmessage = (event) => {
            document.querySelector('.typing-indicator')?.remove();
            addMessage(event.data, 'assistant');
        };
        socket.onclose = () => addMessage('Связь с космосом прервана. Обновите страницу.', 'assistant');
        socket.onerror = (error) => console.error('WebSocket ошибка:', error);
    }

    messageInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && messageInput.value.trim() !== '' && socket?.readyState === WebSocket.OPEN) {
            const message = messageInput.value;
            addMessage(message, 'user');
            socket.send(message);
            messageInput.value = '';
            addTypingIndicator();
        }
    });

    function addMessage(text, role) {
        const msg = document.createElement('div');
        msg.classList.add('message', role);
        msg.textContent = text;
        messagesContainer.appendChild(msg);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function addTypingIndicator() {
        const ind = document.createElement('div');
        ind.classList.add('message', 'assistant', 'typing-indicator');
        ind.textContent = 'Сократ думает...';
        messagesContainer.appendChild(ind);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
</script>

</body>
</html>
